\documentclass[14pt,a4paper]{report}
\usepackage{russ}
\usepackage{mathtools}
\usepackage[left=3cm,right=2cm,top=3cm,bottom=3cm]{geometry}
\usepackage{graphicx}

\usepackage[cp1251]{inputenc}

\begin{document}

\chapter{продолжение}
\subsection{Проекция перспективы}
При проецировании трёхмерного пространства на двумерную плоскость для реалистичности изображения следует сохранять его глубину.
Это достаточно нетривиальная задача. Для её решения используется преобразование, известное как проекция перспективы. Кроме упомянутой задачи, проекция перспективы решает и другую: в современных мониторах ширина экрана, как правило, больше, чем высота. В то же время графический процессор обрабатывает вершины с координатами, лежащими в отрезке [-1.0, 1.0] по всем координатным осям. Это означает, что, например, квадрат будет отображен как прямоугольник. Рассматриваемое преобразование призвано решать эту проблему.
Для построения проекции перспективы используются следующие входные данные:
\begin{enumerate}
\item \begin{math}q\end{math} - соотношение сторон прямоугольной области, на которую будет осуществляться проекция.
\item \begin{math}\alpha\end{math} - угол обзора камеры по вертикали.
\item \begin{math}d_n\end{math} - позиция ближайшей видимой плоскости, перпендикулярной оси \begin{math}z\end{math}.
\item \begin{math}d_f\end{math} - позиция самой дальней видимой плоскости, перпендикулярной оси \begin{math}z\end{math}.
\end{enumerate}
Рассмотрим этапы построения матрицы данного преобразования.
(далее --- проецированных координат). Для начала следует найти расстояние от камеры до плоскости проекции, используя угол обзора по вертикали:

\begin{center}\begin{math} d = \frac{1}{\tan{\frac{\alpha}{2}}} \end{math}\end{center}

Затем можно приступить непосредственно к подсчёту проецированных координат \begin{math}x, y\end{math}.
  Пусть обрабатывается вершина с координатами \begin{math}(x, y, z)\end{math}. Нужно найти \begin{math}(x_p, y_p)\end{math} - соответствующие координаты на плоскости проекции. Рассмотрим следующий рисунок:
  \begin{center}\includegraphics[width=6cm,height=6cm]{cam.png} \end{center}
  Согласно правилу подобных треугольников:
  \begin{center}\begin{math} y_p = \frac{yd}{z} = \frac{y}{z\tan{\frac{\alpha}{2}}},    x_p = \frac{xd}{z} = \frac{x}{z\tan{\frac{\alpha}{2}}}\end{math}\end{center}
   Ширина и высота окна проекции равны, очевидно, \begin{math}2q\end{math} и \begin{math}2\end{math} соответственно. Точка в пространстве попадает в окно проекции, если она проецируется в точку с координатами \begin{math}x_p\in[-q, +q]\end{math},
   \begin{math}y_p\in[-1, 1]\end{math}. Координата \begin{math}y_p\end{math} нормирована, осталось пронормировать координату \begin{math}x_p\end{math}, поделив на соотношение сторон \begin{math}q\end{math}. Теперь точка, с координатой \begin{math}x = q\end{math} имеет координату \begin{math}x_p = 1.0\end{math}, следовательно располагается на правой границе экрана.

   В результате получили следующие выражения для \begin{math}x_p\end{math} и \begin{math}y_p\end{math}:
   \begin{center}\begin{math}y_p = \frac{y}{z\tan{\frac{\alpha}{2}}},    x_p = \frac{x}{qz\tan{\frac{\alpha}{2}}}\end{math}\end{center}
   В обоих выражениях присутствует множитель \begin{math}\frac{1}{z}\end{math} Но координата \begin{math}z\end{math} меняется от вершины к вершине, поэтому этот множитель нельзя поместить в матрицу преобразования, применяемую ко всем вершинам. Возникшая проблема в OpenGL решается следующим образом: умножение вектора позиции вершины на \begin{math}\frac{1}{z}\end{math} выполняется графическим процессором после прохождения вершинного шейдера, а значит из выражений для \begin{math}x_p\end{math}, \begin{math}y_p\end{math} и последующих этот множитель необходимо убрать.
   Сам процесс умножения на \begin{math}\frac{1}{z}\end{math} называется делением перспективы.

   Далее нужно найти инъективное отображение, переводящее отрезок \begin{math}[d_n, d_f]\end{math} в отрезок \begin{math}[-1, 1]\end{math}. Отображение представляет из себя сжатие \begin{math}[d_n, d_f]\end{math} до отрезка длины \begin{math}2\end{math} с последующим совмещением начала полученного отрезка с \begin{math}-1\end{math}. Теперь ясно, что искомое отображение имеет вид:

   \begin{center}\begin{math}f(z) = az + b\end{math}\end{center}

   , где \begin{math}a, b\end{math} некоторые константы, поиску которых посвящён остаток раздела.
   Известно, что когда \begin{math}f(d_n) = -1, f(d_f) = 1\end{math}. Выполним некоторые вычисления, предварительно разделив \begin{math}f(z)\end{math} на \begin{math}z\end{math}:
   \begin{center}\begin{math}a + \frac{b}{d_n} = -1 \Rightarrow a = -1 -\frac{b}{d_n} \end{math};\end{center}


   \begin{center}\begin{math}a + \frac{b}{d_f} = 1 \Rightarrow \frac{b}{d_f} - 1 - \frac{b}{d_n} = 1 \Rightarrow
   b(d_n - d_f) = 2d_n d_f \Rightarrow b = \frac{2d_n d_f}{d_n - d_f}\end{math};\end{center}

   \begin{center}\begin{math}a = -1 - \frac{b}{d_n}  = \frac{-d_n - d_f}{d_n - d_f} \end{math};\end{center}

   Имеем:
   \begin{center}\begin{math}f(z) = \frac{-d_n - d_f}{d_n - d_f}z + \frac{2d_n d_f}{d_n - d_f}\end{math}\end{center}


   Теперь можно составить матрицу проекции перспективы (процесс составления матрицы опускается, поскольку не представляет особого интереса). В результате получается матрица следующего вида:
   \begin{math}
P =
  \begin{pmatrix}
    \frac{1}{q\tan{\frac{\alpha}{2}}} & 0 & 0 & 0 \\
    0 & \frac{1}{\tan{\frac{\alpha}{2}}}  & 0 & 0\\
    0 & 0 & \frac{-d_n - d_f}{d_n - d_f} & \frac{2d_n d_f}{d_n - d_f}\\
    0 & 0 & 1 & 0
  \end{pmatrix},
\end{math}

\section{Камера}
Камера в 3D игре -- это инструмент, позволяющий имитировать разного рода передвижения в пространстве экрана, "око" игрока.
Под имитацией движения в данном случае понимается применение неких преобразований, разговор о которых пойдёт далее.


Положение камеры в пространстве,как и в случае вершин объектов, определяется тремя координатами. Предположим, что камера расположена в начале координат, т.е. в точке с координатами \begin{math}(0.0, 0.0, 0.0)\end{math}. Рассмотрим следующий рисунок (вид сверху против направления оси \begin{math}Oy\end{math}:

  \begin{center}\includegraphics[width=10cm,height=12cm]{D://camera.png} \end{center}
  
  
   Сначала камера направлена против оси \begin{math}Oz\end{math}, затем повернута на \begin{math}45^o\end{math} по часовой стрелке. Камера определяет свою собственную систему координат, которая может совпадать с общей, или мировой системой координат (верхнее изображение) либо не совпадать (нижнее). Пространство, заданное направляющими векторами координатных осей мировой системы координат, называют мировым пространством; заданное направляющими векторами  камеры ---  пространством камеры. В пространстве камеры сама камера расположена в начале координат.
    
    Поворот камеры на угол \begin{math}\alpha\end{math} эквивалентен повороту мирового пространства на угол \begin{math}-\alpha\end{math}. Движение мирового пространства всегда противоположно движению камеры.
    Поэтому преобразований, связанных с камерой, два: движение мирового пространства до совпадения координат камеры с началом мировых координат и его поворот в направлении, противоположном вращению камеры.
    
    Движение камеры осуществляется следующим образом: если координаты камеры \begin{math}(x, y, z)\end{math}, то преобразование позиции имеет вид \begin{math}(-x, -y, -z)\end{math}. Объясняется это тем, что камера расположена в мировой системе координат с использованием перемещения, основанного на векторе \begin{math}(x, y, z)\end{math}, поэтому, чтобы поместить ее в начало координат, необходимо преобразование, обратное данному. Таким образом, матрица движения камеры имеет вид:
    
    \begin{math}
  T_k = \begin{pmatrix}
    1 & 0  & 0 & x\\
    0 & 1 & 0 & y\\
    0 & 0 & 1 & z\\
      0 & 0 & 0 & 1
  \end{pmatrix}^{-1} = \begin{pmatrix}
    1 & 0  & 0 & -x\\
    0 & 1 & 0 & -y\\
    0 & 0 & 1 & -z\\
      0 & 0 & 0 & 1
  \end{pmatrix}
\end{math}
     
 Далее осуществляется поворот камеры на некоторые значения, указанные в мировых координатах. О повороте будет упомянуто ниже, для начала следует рассмотреть вопрос о положении объектов в системе координат камеры. Здесь имеет место переход из мировой системы координат в систему координат камеры. Базис мирового пространства может быть представлен ортонормированной системой векторов
 \begin{math}\vec{a_1}(1, 0, 0), \vec{a_2}(0, 1, 0), \vec{a_3}(0, 0, 1), \end{math}, базис пространства камеры тоже можно представить ортонормированной системой \begin{math}\vec{b_1}, \vec{b_2}, \vec{b_3}, \end{math}.
 Матрица перехода от базиса первого базиса ко второму является ортогональной, поскольку оба базиса ортонормированы, и имеет следующий вид:    
 С =\begin{math} \begin{pmatrix}
    b_{1x} & b_{2x}  & b_{3x} & 0\\
    b_{1y} & b_{2y} & b_{3y} & 0\\
    b_{1z} & b_{2z} & b_{3z} & 0\\
    0 & 0 & 0 & 1
  \end{pmatrix}\end{math}
  
  По формуле преобразования координат при переходе от базиса \begin{math}\vec{a_i}\end{math} к базису \begin{math} \vec{b_i}\end{math}:
  \begin{math}v_b = C^{-1}v_e\end{math}
  Поскольку для ортогональной матрицы верно \begin{math}C^{-1} = C^{T}\end{math}, имеем:
  
  \begin{math}
  \begin{pmatrix}
    e_{bx}\\
    e_{by}\\
    e_{bz}\\
    1
  \end{pmatrix} = 
  \begin{pmatrix}
    b_{1x} & b_{1y}  & b_{1z} & 0\\
    b_{2x} & b_{2y} & b_{2z} & 0\\
    b_{3x} & b_{3y} & b_{3z} & 0\\
    0 & 0 & 0 & 1
  \end{pmatrix}
    \begin{pmatrix}
    e_{ax}\\
    e_{ay}\\
    e_{az}\\
    1
  \end{pmatrix}
  \end{math}
  
  Векторы \begin{math}\vec{b_1}, \vec{b_2},\vec{b_3}\end{math} базиса пространства камеры часто обозначаются соответственно \begin{math}\vec{U}\end{math}, \begin{math}\vec{V}\end{math} и \begin{math}\vec{N}\end{math} соответственно. Вектор \begin{math}\vec{U}\end{math} определяет ось направления, \begin{math}\vec{V}\end{math} - вертикальную ось, \begin{math}\vec{N}\end{math} - горизонтальную.
  Поворот камеры осуществляется в два этапа: поворот вектора U на горизонтальный угол, затем на вертикальный.  
  Для задачи вращения камеры вокруг произвольного вектора есть простое математическое решение - кватернионы. 
   Кватернионы являются 4-х мерным расширением множества комплексных чисел, другими словами ---  это гиперкомплексные числа,  
   то есть кватернион \begin{math}Q\end{math} задаётся четвёркой чисел \begin{math}(x, y, z, w)\end{math}:
   
   \begin{math}Q = xi + yj +zk + w\end{math}
, где \begin{math}i^2 = j^2 = k^2 = -1\end{math}.

  Кватернион, сопряжённый данному: \begin{math}Q^{-1} = -xi - yj - zk + w\end{math}
  Нормирование кватернионов определеятся аналогично нормированию векторов.
  
  Формула для подсчета кватерниона \begin{math}w\end{math}, являющегося результатом поворота вектора \begin{math}\vec{v}\end{math} на угол \begin{math}\alpha\end{math} вокруг оси \begin{math}l\end{math}:
  \begin{math}w = q\vec{v}q^{-1}\end{math} , где q - кватернион вращения, имеющий вид:
  
  \begin{math}
  q = 
    \begin{pmatrix}
    l_x \sin{\frac{\alpha}{2}}\\
    l_y\sin{\frac{\alpha}{2}}\\
    l_z\sin{\frac{\alpha}{2}}\\
    \cos{\frac{\alpha}{2}}
  \end{pmatrix}
  \end{math}  

    После подсчета w повернутый вектор имеет координаты \begin{math}(w_x,w_y,w_z)\end{math}.

    Идея поворота камеры состоит в том, чтобы вектор \begin{math}\vec{a}\end{math}, имеющий в пространстве камеры координаты \begin{math}(1, 0, 0)\end{math} повернуть на горизонтальный угол вокруг вектора \begin{math}\vec{V}\end{math}, затем перемножить векторно \begin{math}\vec{V}\end{math} и \begin{math}\vec{a}\end{math} для получения нового вектора \begin{math}\vec{U}\end{math} (чтобы новые векторы стали ортогональными), после повернуть \begin{math}\vec{a}\end{math} на вертикальный угол вокруг \begin{math}\vec{U}\end{math} и получить новый вектор \begin{math}\vec{V}\end{math} как результат векторного произведения \begin{math}\vec{a} \times \vec{U}\end{math}. Также после каждой из операций новые векторы следует нормировать, поскольку каждый полученный вектор не обязательно единичный.
    
\end{document} 


